\section{Análisis y preprocesado de los datos}

\subsection{Análisis del conjunto de datos}

Nuestro conjunto de datos se compone de tres ficheros:

\begin{enumerate}
	\item \texttt{lateralidad0.arff} : 439 muestras de la lateralidad izquierda del pubis.
	\item \texttt{lateralidad1.arff} : 453 muestras de la lateralidad derecha del pubis.
	\item \texttt{completo.arff} : 892 muestas de ambas lateralidades, se compone de los dos ficheros antes en conjunto.
\end{enumerate}

\begin{figure}[H]
	\begin{lstlisting}[language={}]
	NoGrooves,Absence,Defined,Absent,Defined,Present,Absent,Absent,FormedWithoutRarefactions,Ph07-35-39
	\end{lstlisting}
	\caption{Ejemplo de un dato cuya edad de muerte está en el rango comprendido por la fase 7, entre 35 y 39 años, del conjunto de datos \texttt{completo.arff}.}
	\label{fig:ejemplo_dato}
\end{figure}

Como vemos en la figura \ref{fig:ejemplo_dato} los datos tienen asignados valores categóricos para cada característica, y finalmente la edad a la que murió la persona con las características asociadas.

Para comenzar, realizaremos un análisis de cada uno de los conjuntos de datos. Como el conjunto de datos completo se trata simplemente de la unión de los datos de la lateralizad izquierda y la derecha, será el último análisis que realicemos.

\subsubsection{Análisis de la lateralidad izquierda}

Este conjunto de datos cuenta con 439 muestras. Vamos a ver de forma gráfica como se distribuyen los datos según las fases propuestas por Todd, comentando la información que nos puede ser de utilidad de cada gráfico:

\begin{figure}[H]
	\centering
	\includegraphics[width = \textwidth]{conjunto_datos/distribucion_clases_lateralidad_izquierda.png}
	\caption{Número de datos por cada fase propuesta por Todd con el conjunto de datos de la lateralidad izquierda.}
	\label{fig:conteo_l0}
\end{figure}

Podemos ver que contamos con una cantidad muy alta de observaciones de las últimas fases en comparación con las primeras fases, en especial de la última fase, de personas de más de cincuenta años.

Debido a que todas las variables del conjunto de datos son categóricas, para este análisis solo podemos observar como se distribuyen los valores de cada predictor para cada fase. Vamos ver cada uno de estos predictores y comentar la información que nos proporcionan.

\begin{figure}[H]
	\centering
	\includegraphics[width = \textwidth]{conjunto_datos/densidad_IrregularPorosity_lateralidad_izquierda.png}
	\caption{Distribución de los valores de IrregularPorosity en el conjunto de datos de la lateralidad izquierda.}
	\label{fig:densidad_IrregularPorosity_lateralidad_izquierda}
\end{figure}

En la figura \ref{fig:densidad_IrregularPorosity_lateralidad_izquierda} podemos observar la distribución de valores de \texttt{IrregularPorosity}. En este vemos como claramente con esta característica podremos clasificar observaciones de clases altas si el valor de esta variable es \texttt{Much}, mientras que con el valor \texttt{Medium} y en especial \texttt{Absence} si hay un mayor solapamiento entre las clases.

Aun así, podemos ver como esta característica tampoco nos aporta gran información para las fases más bajas, donde si se solapa este valor. Vamos a seguir observando el resto de predictores.

\begin{figure}[H]
	\centering
	\includegraphics[width = \textwidth]{conjunto_datos/densidad_UpperSymphysialExtremity_lateralidad_izquierda.png}
	\caption{Distribución de los valores de UpperSymphysialExtremity en el conjunto de datos de la lateralidad izquierda.}
	\label{fig:densidad_UpperSymphysialExtremity_lateralidad_izquierda}
\end{figure}

En este caso con \texttt{UpperSymphysialExtremity}, como vemos en la figura \ref{fig:densidad_UpperSymphysialExtremity_lateralidad_izquierda}, ocurre lo contrario que en el caso anterior. Esta característica nos podría servir muy bien para predecir asegurarnos que estamos ante observaciones de fases bajas si toma el valor de \texttt{NotDefined}, sin embargo vemos como las observaciones con este valor siguen existiendo tres posibles clases, por lo que realmente no hemos resuelto por completo estas observaciones, pero si acotado bastante el rango de fases, al ser tres contiguas.

\begin{figure}[H]
	\centering
	\includegraphics[width = \textwidth]{conjunto_datos/densidad_BonyNodule_lateralidad_izquierda.png}
	\caption{Distribución de los valores de BonyNodule en el conjunto de datos de la lateralidad izquierda.}
	\label{fig:densidad_BonyNodule_lateralidad_izquierda}
\end{figure}

Para la variable \texttt{BonyNodule} ocurre lo mismo que con la variable anterior, \texttt{UpperSymphysialExtremity}. Cuando se toma el valor de \texttt{Present} vemos como todas las observaciones son de fases bajas, aunque sigue existiendo ciertas dudas sobre la fase concreta. Cuando toma el valor de \texttt{Absent} no se puede sacar ninguna conclusión debido a que encontramos valores de todas las clases.

\begin{figure}[H]
	\centering
	\includegraphics[width = \textwidth]{conjunto_datos/densidad_LowerSymphysialExtremity_lateralidad_izquierda.png}
	\caption{Distribución de los valores de LowerSymphysialExtremity en el conjunto de datos de la lateralidad izquierda.}
	\label{fig:densidad_LowerSymphysialExtremity_lateralidad_izquierda}
\end{figure}

Con \texttt{LowerSymphysialExtremity} se puede observar que ocurre al igual que en casos anteriores, si toma el valor \texttt{NotDefined} podemos ver que se trata de una fase baja, sin embargo, en este caso si que nos llega a aportar algo más de información. En los casos anteriores, aunque un valor nos discriminaba muy bien si era de una fase temprana o no, el valor contrario seguía teniendo valores de todas las clases, es decir, si por ejemplo \texttt{BonyNodule} toma el valor \texttt{Present}, sabemos que se trata de una fase temprana, sin embargo si toma el valor \texttt{Absent} no podemos decir nada, porque podría ser de cualquier fase, sin embargo, con \texttt{LowerSymphysialExtremity} podemos ver claramente como si es \texttt{NotDefined} será de una clase baja, pero si es \texttt{Defined} podemos concluir que, al menos de la primera fase no será esta observación, ya que no encontramos observaciones de esta fase, y muy pocas de la fase dos y tres.

\begin{figure}[H]
	\centering
	\includegraphics[width = \textwidth]{conjunto_datos/densidad_DorsalMargin_lateralidad_izquierda.png}
	\caption{Distribución de los valores de DorsalMargin en el conjunto de datos de la lateralidad izquierda.}
	\label{fig:densidad_DorsalMargin_izquierda}
\end{figure}

En este caso \texttt{DorsalMargin} vemos como no aporta información alguna, ya que solo toma un valor independientemente de la fase de edad. Si esto sigue ocurriendo en la lateralidad derecha (y por lo tanto en el conjunto completo, al ser la unión de este conjunto y la lateralidad derecha), podemos eliminar esta característica a la hora de entrenar el modelo ya que no aportaría información alguna al modelo.

\begin{figure}[H]
	\centering
	\includegraphics[width = \textwidth]{conjunto_datos/densidad_DorsalPlaeau_lateralidad_izquierda.png}
	\caption{Distribución de los valores de DorsalPlaeau en el conjunto de datos de la lateralidad izquierda.}
	\label{fig:densidad_DorsalPlaeau_izquierda}
\end{figure}

Para los valores de \texttt{DorsalPlaeau} vemos como si que toma distintos valores, sin embargo estos no nos aportan mucha información, ya que tanto para \texttt{Absent} como para \texttt{Present} contamos con observaciones de todo tipo de fases, tanto altas como bajas, luego a priori no podemos saber si este predictor será de gran utilidad.

\begin{figure}[H]
	\centering
	\includegraphics[width = \textwidth]{conjunto_datos/densidad_VentralBevel_lateralidad_izquierda.png}
	\caption{Distribución de los valores de VentralBevel en el conjunto de datos de la lateralidad izquierda.}
	\label{fig:densidad_VentralBevel_izquierda}
\end{figure}

Aunque con \texttt{VentralBevel} vemos como para los distintos valores tenemos una gran variedad de clases, si que podemos sacar algunas conclusiones de este gráfico, voy a comentarlas según cada valor que puede tomar esta variable. Empezando con \texttt{Absent}, podemos ver como no podemos sacar ninguna conclusión, al tener observaciones de todo tipo de fases. Con \texttt{InProcess} se observa que aunque sigue existiendo observaciones de casi todas las fases, no tenemos de la fase uno, y las observaciones de la fase dos sin mínimas. Esto sumado a que con valores de \texttt{Present} solo se tienen observaciones de fases mayores a la fase cinco, este predictor nos puede ser de utilidad para acotar el resultado, ya que gran cantidad de observaciones toman el valor de \texttt{Present}, y con esto sabemos que son de una fase más alta y aunque siga existiendo variedad de clases, hemos conseguido acotarla.


\begin{figure}[H]
	\centering
	\includegraphics[width = \textwidth]{conjunto_datos/densidad_VentralMargin_lateralidad_izquierda.png}
	\caption{Distribución de los valores de VentralMargin en el conjunto de datos de la lateralidad izquierda.}
	\label{fig:densidad_VentralMargin_izquierda}
\end{figure}

Para \texttt{VentralMargin} vemos como claramente si toma el valor de \texttt{Absent} nos indica que la observación de una fase temprana, si toma el valor de \texttt{PartiallyFormed} estamos ante una observación de una fase mayor o igual a la sexta, y si toma el valor de \texttt{FormedWithoutRarefactions} se trata de una observación de la última fase. Con respecto al resto de valores, \texttt{FormedWithFewRarefactions} sigue teniendo una cantidad alta de fases, pero nos puede dar la información de que la observación no es de las tres fases más tempranas, mientras que \texttt{FormedWithLotRecessesAndProtrusions} no nos da ninguna información de la clase debido al solape de fases que existen.

\subsubsection{Análisis de la lateralidad derecha}

Este conjunto de datos cuenta con 453 muestras. Al igual que con la lateralidad izquierda, vamos a ver de forma gráfica como se distribuyen los datos según las fases propuestas por Todd. Debido a la similitud de con la lateralidad izquierda, si las conclusiones obtenidas son semejantes a las obtenidas anteriormente para cada predictor no se comentarán por evitar repetirse:

\begin{figure}[H]
	\centering
	\includegraphics[width = \textwidth]{conjunto_datos/distribucion_clases_lateralidad_derecha.png}
	\caption{Número de datos por cada fase propuesta por Todd con el conjunto de datos de la lateralidad derecha.}
	\label{fig:conteo_l1}
\end{figure}


\begin{figure}[H]
	\centering
	\includegraphics[width = \textwidth]{conjunto_datos/densidad_IrregularPorosity_lateralidad_derecha.png}
	\caption{Distribución de los valores de IrregularPorosity en el conjunto de datos de la lateralidad derecha.}
	\label{fig:densidad_IrregularPorosity_lateralidad_derecha}
\end{figure}

\begin{figure}[H]
	\centering
	\includegraphics[width = \textwidth]{conjunto_datos/densidad_UpperSymphysialExtremity_lateralidad_derecha.png}
	\caption{Distribución de los valores de UpperSymphysialExtremity en el conjunto de datos de la lateralidad derecha.}
	\label{fig:densidad_UpperSymphysialExtremity_lateralidad_derecha}
\end{figure}


\begin{figure}[H]
	\centering
	\includegraphics[width = \textwidth]{conjunto_datos/densidad_BonyNodule_lateralidad_derecha.png}
	\caption{Distribución de los valores de BonyNodule en el conjunto de datos de la lateralidad derecha.}
	\label{fig:densidad_BonyNodule_lateralidad_derecha}
\end{figure}



\begin{figure}[H]
	\centering
	\includegraphics[width = \textwidth]{conjunto_datos/densidad_LowerSymphysialExtremity_lateralidad_derecha.png}
	\caption{Distribución de los valores de LowerSymphysialExtremity en el conjunto de datos de la lateralidad derecha.}
	\label{fig:densidad_LowerSymphysialExtremity_derecha}
\end{figure}


\begin{figure}[H]
	\centering
	\includegraphics[width = \textwidth]{conjunto_datos/densidad_DorsalMargin_lateralidad_derecha.png}
	\caption{Distribución de los valores de DorsalMargin en el conjunto de datos de la lateralidad derecha.}
	\label{fig:densidad_DorsalMargin_derecha}
\end{figure}

\begin{figure}[H]
	\centering
	\includegraphics[width = \textwidth]{conjunto_datos/densidad_DorsalPlaeau_lateralidad_derecha.png}
	\caption{Distribución de los valores de DorsalPlaeau en el conjunto de datos de la lateralidad derecha.}
	\label{fig:densidad_DorsalPlaeau_derecha}
\end{figure}


\begin{figure}[H]
	\centering
	\includegraphics[width = \textwidth]{conjunto_datos/densidad_VentralBevel_lateralidad_derecha.png}
	\caption{Distribución de los valores de VentralBevel en el conjunto de datos de la lateralidad derecha.}
	\label{fig:densidad_VentralBevel_derecha}
\end{figure}

\begin{figure}[H]
	\centering
	\includegraphics[width = \textwidth]{conjunto_datos/densidad_VentralMargin_lateralidad_derecha.png}
	\caption{Distribución de los valores de VentralMargin en el conjunto de datos de la lateralidad derecha.}
	\label{fig:densidad_VentralMargin_derecha}
\end{figure}

\subsubsection{Análisis del conjunto completo}



% TODO: actualizar toda la parte de sobremuestro, explicando SMOTE, borderline-SMOTE, ADASYN,
% comentar como funciona en nuestro conjunto de datos


\subsection{Sobremuestreo} \label{sobremuestreo}

En esta sección introduciremos SMOTE y Borderline SMOTE de cara a mostrar la idea original de sobremuestreo en problemas de clasificación, su adaptación a problemas de regresión con SMOTER y finalmente una mejora de este último, SMOGN, que será el algoritmo a utilizar.

\subsubsection{SMOTE}

SMOTE se trata de un método para conseguir balancear el número de datos para un problema de clasificación creando nuevos datos de las clases minoritarias de forma sintética.

Las clases minoritarias se sobremuestrean tomando cada muestra de dicha clase minoritaria, e introduciendo valores sintéticos a lo largo del segmento que une a todos o a cualquiera de los $k$ vecinos más cercanos de la clase. Dependiendo de la cantidad de datos sintéticos a generar se escogerá el valor de $k$ para seleccionar más o menos vecinos.


\begin{figure}[H]
	\centering
	\includegraphics[scale = 1]{ej_smote.png}
	\caption{Comparación de SMOTE con otros métodos de sobremuestreo en el conjunto de datos Phonome. En el eje X los falsos positivos y en el eje Y los verdaderos positivos. Imagen obtenida de \cite{SMOTE}.}
	\label{fig:comparacionSMOTE}
\end{figure}

Como vemos en la figura \ref{fig:comparacionSMOTE}, este método se comporta bastante bien en comparación con otros métodos y es capaz de obtener buenos resultados, sin embargo, tiene algunos problemas.

Uno de estos problemas es que cuando existe ruido entre las clases, o las clases se encuentran dispersas por el espacio de valores, gran parte de los valores sintéticos se encontrarán en una zona del espacio que no corresponde a su clase.

Este problema se hace mucho más presente en nuestro caso, al contar con tantas clases y con tantas características, y para resolverlo se propuso la variante Borderline-SMOTE.

\subsubsection{Borderline SMOTE}


Borderline SMOTE \cite{BL-SMOTE} se trata de una variante de SMOTE que propone buscar los límites en el espacio de valores de la clase a obtener nuevos datos sintéticos, de forma que cuando se generen dichos datos nuevos, estén dentro de dichos límites. De esta forma evitamos problemas con conjuntos de datos con mucho ruido y múltiples clases.

En su artículo proponen dos variantes, una donde las nuevas muestras sintéticas son creadas a partir de todo el conjunto de datos, y otra donde las nuevas muestras solo se generan a partir de los datos considerados en el límite.


\begin{figure}[H]
    \centering
    \begin{subfigure}[b]{0.33\textwidth}
		  \includegraphics[width=\textwidth]{bl-smote-original.png}
        \caption{}
        \label{fig:blSMOTE-orig}
    \end{subfigure}
    \begin{subfigure}[b]{0.33\textwidth}
        \includegraphics[width=\textwidth]{bl-smote-datos-borderline.png}
        \caption{}
        \label{fig:blSMOTE-border}
    \end{subfigure}
    \begin{subfigure}[b]{0.33\textwidth}
        \includegraphics[width=\textwidth]{bl-smote-datos-sinteticos.png}
        \caption{}
        \label{fig:blSMOTE-sintetico}
    \end{subfigure}

    \caption{\ref{fig:blSMOTE-orig} Conjunto de datos original. \ref{fig:blSMOTE-border} datos que conforman el límite de la clase minoritaria (cuadros azules rellenos). \ref{fig:blSMOTE-sintetico} Nuevos datos generados de forma sintética dentro de los límites de la clase (cuadros azules no rellenos). Imagen obtenida de \cite{BL-SMOTE}.}
	 \label{fig:ejemploBL-SMOTE}

\end{figure}


\begin{figure}[H]
    \centering
	 \begin{subfigure}[b]{\textwidth}
		 \centering
		 \includegraphics[width=0.8\textwidth]{resampling_smote.png}
		 \caption{A la izquierda bordes de las clases, y a la derecha sobremuestreo con SMOTE}
		 \label{fig:SMOTE-cmp}
	 \end{subfigure}

    \begin{subfigure}[b]{\textwidth}
		 \centering
		  \includegraphics[width=0.8\textwidth]{resampling_blsmote.png}
        \caption{A la izquierda bordes de las clases, y a la derecha sobremuestreo con BorderlineSMOTE}
        \label{fig:BLSMOTE-cmp}
    \end{subfigure}

    \caption{Comparación de SMOTE y BorderlineSMOTE para un conjunto de datos generado aleatoriamente.}\label{fig:BLSMOTE-SMOTE}

\end{figure}

Esta claro que, como vemos en la figura \ref{fig:ejemploBL-SMOTE} y la figura \ref{fig:BLSMOTE-SMOTE}, esta técnica es mucho más versátil y conveniente que SMOTE.


\newpage

\subsection{Resultado tras el preprocesado}

% TODO: Ampliar esto cuando se aplique el preprocesado


\newpage
